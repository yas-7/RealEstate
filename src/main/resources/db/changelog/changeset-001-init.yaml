databaseChangeLog:
  - changeSet:
      id: 001-create-complexes-flats-history
      author: your_name
      changes:
        # 1) ЖК (complexes)
        - createTable:
            tableName: complexes
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: name
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: city
                  type: TEXT
              - column:
                  name: address
                  type: TEXT
              - column:
                  name: developer
                  type: TEXT
              - column:
                  name: created_at
                  type: TIMESTAMP
                  defaultValueComputed: now()
                  constraints:
                    nullable: false

        # 2) Квартиры (flats)
        - createTable:
            tableName: flats
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: complex_id
                  type: BIGINT
                  constraints:
                    nullable: false
                    foreignKeyName: fk_flats_complex
                    references: complexes(id)
                    deleteCascade: true
              - column:
                  name: building
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: number
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: floor
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: rooms
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: area_total
                  type: NUMERIC(8,2)
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP
                  defaultValueComputed: now()
                  constraints:
                    nullable: false

        - addUniqueConstraint:
            tableName: flats
            columnNames: complex_id, building, number
            constraintName: uq_flats_complex_building_number

        # 3) История цен (flat_price_history)
        - createTable:
            tableName: flat_price_history
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: flat_id
                  type: BIGINT
                  constraints:
                    nullable: false
                    foreignKeyName: fk_pricehistory_flat
                    references: flats(id)
                    deleteCascade: true
              - column:
                  name: price_total
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: price_per_m2
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP
                  defaultValueComputed: now()
                  constraints:
                    nullable: false

        # Индексы
        - createIndex:
            tableName: flats
            indexName: idx_flats_complex_building
            columns:
              - column:
                  name: complex_id
              - column:
                  name: building

        - createIndex:
            tableName: flat_price_history
            indexName: idx_price_hist_flat_created_at
            columns:
              - column:
                  name: flat_id
              - column:
                  name: created_at

        - createIndex:
            tableName: flat_price_history
            indexName: idx_price_hist_price_total
            columns:
              - column:
                  name: price_total
              - column:
                  name: created_at

        - createIndex:
            tableName: flat_price_history
            indexName: idx_price_hist_price_per_m2
            columns:
              - column:
                  name: price_per_m2
              - column:
                  name: created_at
